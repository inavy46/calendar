<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>工作行事曆系統</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background-color: #f9fafb;
        }
        .calendar-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 24px;
        }
        .icon {
            width: 16px;
            height: 16px;
            stroke-width: 2;
            fill: none;
            stroke: currentColor;
        }
        .icon-lg {
            width: 24px;
            height: 24px;
        }
        .icon-xl {
            width: 32px;
            height: 32px;
        }
        .icon-sm {
            width: 12px;
            height: 12px;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script>
        const { useState, useEffect, createElement: h } = React;
        
        // SVG 圖示組件
        const Icons = {
            Calendar: (props) => h('svg', { className: `icon ${props.className || ''}`, viewBox: '0 0 24 24' },
                h('rect', { width: '18', height: '18', x: '3', y: '4', rx: '2', ry: '2' }),
                h('line', { x1: '16', x2: '16', y1: '2', y2: '6' }),
                h('line', { x1: '8', x2: '8', y1: '2', y2: '6' }),
                h('line', { x1: '3', x2: '21', y1: '10', y2: '10' })
            ),
            Clock: (props) => h('svg', { className: `icon ${props.className || ''}`, viewBox: '0 0 24 24' },
                h('circle', { cx: '12', cy: '12', r: '10' }),
                h('polyline', { points: '12,6 12,12 16,14' })
            ),
            Users: (props) => h('svg', { className: `icon ${props.className || ''}`, viewBox: '0 0 24 24' },
                h('path', { d: 'm16 21-4-4-4 4' }),
                h('circle', { cx: '12', cy: '7', r: '4' })
            ),
            MessageSquare: (props) => h('svg', { className: `icon ${props.className || ''}`, viewBox: '0 0 24 24' },
                h('path', { d: 'M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z' })
            ),
            Palette: (props) => h('svg', { className: `icon ${props.className || ''}`, viewBox: '0 0 24 24' },
                h('circle', { cx: '13.5', cy: '6.5', r: '.5' }),
                h('circle', { cx: '17.5', cy: '10.5', r: '.5' }),
                h('circle', { cx: '8.5', cy: '7.5', r: '.5' }),
                h('circle', { cx: '6.5', cy: '12.5', r: '.5' }),
                h('path', { d: 'M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c.926 0 1.648-.746 1.648-1.688 0-.437-.18-.835-.437-1.125-.29-.289-.438-.652-.438-1.125a1.64 1.64 0 0 1 1.668-1.668h1.996c3.051 0 5.555-2.503 5.555-5.554C21.965 6.012 17.461 2 12 2z' })
            ),
            Search: (props) => h('svg', { className: `icon ${props.className || ''}`, viewBox: '0 0 24 24' },
                h('circle', { cx: '11', cy: '11', r: '8' }),
                h('path', { d: 'm21 21-4.35-4.35' })
            ),
            Wrench: (props) => h('svg', { className: `icon ${props.className || ''}`, viewBox: '0 0 24 24' },
                h('path', { d: 'M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z' })
            ),
            Plus: (props) => h('svg', { className: `icon ${props.className || ''}`, viewBox: '0 0 24 24' },
                h('path', { d: 'M5 12h14' }),
                h('path', { d: 'm12 5 0 14' })
            ),
            X: (props) => h('svg', { className: `icon ${props.className || ''}`, viewBox: '0 0 24 24' },
                h('path', { d: 'M18 6 6 18' }),
                h('path', { d: 'm6 6 12 12' })
            ),
            BarChart3: (props) => h('svg', { className: `icon ${props.className || ''}`, viewBox: '0 0 24 24' },
                h('path', { d: 'M3 3v18h18' }),
                h('path', { d: 'M18 17V9' }),
                h('path', { d: 'M13 17V5' }),
                h('path', { d: 'M8 17v-3' })
            ),
            ChevronLeft: (props) => h('svg', { className: `icon ${props.className || ''}`, viewBox: '0 0 24 24' },
                h('path', { d: 'm15 18-6-6 6-6' })
            ),
            ChevronRight: (props) => h('svg', { className: `icon ${props.className || ''}`, viewBox: '0 0 24 24' },
                h('path', { d: 'm9 18 6-6-6-6' })
            )
        };

        const WorkCalendar = () => {
            const [currentDate, setCurrentDate] = useState(new Date());
            const [events, setEvents] = useState(() => {
                try {
                    const saved = localStorage.getItem('calendarEvents');
                    return saved ? JSON.parse(saved) : {};
                } catch (e) {
                    return {};
                }
            });
            const [showModal, setShowModal] = useState(false);
            const [selectedDate, setSelectedDate] = useState(null);
            const [eventForm, setEventForm] = useState({
                startTime: '',
                endTime: '',
                type: 'meeting',
                description: ''
            });

            // 儲存到 localStorage
            useEffect(() => {
                try {
                    localStorage.setItem('calendarEvents', JSON.stringify(events));
                } catch (e) {
                    console.error('無法儲存資料到 localStorage:', e);
                }
            }, [events]);

            const workTypes = [
                { id: 'meeting', name: '會議', icon: Icons.Users, color: 'bg-blue-500' },
                { id: 'communication', name: '溝通', icon: Icons.MessageSquare, color: 'bg-green-500' },
                { id: 'design', name: '產品設計', icon: Icons.Palette, color: 'bg-purple-500' },
                { id: 'research', name: '研究', icon: Icons.Search, color: 'bg-orange-500' },
                { id: 'inspection', name: '案場排查', icon: Icons.Wrench, color: 'bg-red-500' },
                { id: 'other', name: '其他', icon: Icons.Clock, color: 'bg-gray-500' }
            ];

            const months = ['一月', '二月', '三月', '四月', '五月', '六月', '七月', '八月', '九月', '十月', '十一月', '十二月'];
            const weekdays = ['日', '一', '二', '三', '四', '五', '六'];

            const getMonthData = () => {
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();
                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                const startDate = new Date(firstDay);
                startDate.setDate(startDate.getDate() - firstDay.getDay());
                
                const days = [];
                const endDate = new Date(startDate);
                endDate.setDate(endDate.getDate() + 41);
                
                for (let date = new Date(startDate); date <= endDate; date.setDate(date.getDate() + 1)) {
                    days.push(new Date(date));
                }
                
                return { firstDay, lastDay, days };
            };

            const formatDate = (date) => {
                return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
            };

            const calculateDuration = (start, end) => {
                const startTime = new Date(`2000/01/01 ${start}`);
                const endTime = new Date(`2000/01/01 ${end}`);
                const diffMs = endTime - startTime;
                return diffMs / (1000 * 60 * 60);
            };

            const getMonthlyStats = () => {
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();
                const stats = {};
                
                workTypes.forEach(type => {
                    stats[type.id] = { hours: 0, name: type.name, color: type.color };
                });

                Object.keys(events).forEach(dateKey => {
                    const date = new Date(dateKey);
                    if (date.getFullYear() === year && date.getMonth() === month) {
                        events[dateKey].forEach(event => {
                            const duration = calculateDuration(event.startTime, event.endTime);
                            stats[event.type].hours += duration;
                        });
                    }
                });

                const totalHours = Object.values(stats).reduce((sum, stat) => sum + stat.hours, 0);
                
                return Object.keys(stats).map(key => ({
                    ...stats[key],
                    percentage: totalHours > 0 ? ((stats[key].hours / totalHours) * 100).toFixed(1) : 0
                })).filter(stat => stat.hours > 0);
            };

            const handleDateClick = (date) => {
                setSelectedDate(date);
                setEventForm({
                    startTime: '',
                    endTime: '',
                    type: 'meeting',
                    description: ''
                });
                setShowModal(true);
            };

            const handleSubmit = () => {
                if (!eventForm.startTime || !eventForm.endTime || !eventForm.description.trim()) {
                    alert('請填寫所有必要欄位');
                    return;
                }

                const dateKey = formatDate(selectedDate);
                const newEvent = {
                    id: Date.now(),
                    startTime: eventForm.startTime,
                    endTime: eventForm.endTime,
                    type: eventForm.type,
                    description: eventForm.description.trim()
                };

                setEvents(prev => ({
                    ...prev,
                    [dateKey]: [...(prev[dateKey] || []), newEvent]
                }));

                setShowModal(false);
            };

            const removeEvent = (date, eventId) => {
                const dateKey = formatDate(date);
                setEvents(prev => ({
                    ...prev,
                    [dateKey]: prev[dateKey].filter(event => event.id !== eventId)
                }));
            };

            const navigateMonth = (direction) => {
                setCurrentDate(prev => {
                    const newDate = new Date(prev);
                    newDate.setMonth(newDate.getMonth() + direction);
                    return newDate;
                });
            };

            const { firstDay, lastDay, days } = getMonthData();
            const monthlyStats = getMonthlyStats();

            return h('div', { className: 'calendar-container' },
                // Header
                h('div', { className: 'bg-white rounded-2xl shadow-sm border border-gray-100 mb-6 p-6' },
                    h('div', { className: 'flex items-center justify-between' },
                        h('div', { className: 'flex items-center gap-3' },
                            h(Icons.Calendar, { className: 'icon-xl text-blue-600' }),
                            h('h1', { className: 'text-2xl font-bold text-gray-800' }, '工作行事曆')
                        ),
                        h('div', { className: 'flex items-center gap-4' },
                            h('button', {
                                onClick: () => navigateMonth(-1),
                                className: 'p-2 hover:bg-gray-100 rounded-lg transition-colors'
                            }, h(Icons.ChevronLeft, { className: 'icon-lg' })),
                            h('h2', { 
                                className: 'text-xl font-semibold text-gray-700 min-w-[120px] text-center' 
                            }, `${currentDate.getFullYear()}年 ${months[currentDate.getMonth()]}`),
                            h('button', {
                                onClick: () => navigateMonth(1),
                                className: 'p-2 hover:bg-gray-100 rounded-lg transition-colors'
                            }, h(Icons.ChevronRight, { className: 'icon-lg' }))
                        )
                    )
                ),

                // Calendar Grid
                h('div', { className: 'bg-white rounded-2xl shadow-sm border border-gray-100 mb-6 overflow-hidden' },
                    // Weekday Headers
                    h('div', { className: 'grid grid-cols-7 border-b border-gray-200' },
                        weekdays.map((day, index) =>
                            h('div', {
                                key: day,
                                className: `p-4 text-center font-medium ${index === 0 || index === 6 ? 'text-red-500' : 'text-gray-600'} bg-gray-50`
                            }, day)
                        )
                    ),

                    // Calendar Days
                    h('div', { className: 'grid grid-cols-7' },
                        days.map((date, index) => {
                            const isCurrentMonth = date.getMonth() === currentDate.getMonth();
                            const isToday = formatDate(date) === formatDate(new Date());
                            const dateKey = formatDate(date);
                            const dayEvents = events[dateKey] || [];
                            const isWeekend = date.getDay() === 0 || date.getDay() === 6;

                            return h('div', {
                                key: index,
                                className: `min-h-[120px] p-2 border-b border-r border-gray-100 cursor-pointer transition-all hover:bg-gray-50 ${
                                    !isCurrentMonth ? 'bg-gray-25 text-gray-400' : ''
                                } ${isToday ? 'bg-blue-50' : ''}`,
                                onClick: () => handleDateClick(date)
                            },
                                h('div', {
                                    className: `font-medium mb-2 ${isToday ? 'text-blue-600' : isCurrentMonth ? (isWeekend ? 'text-red-500' : 'text-gray-700') : 'text-gray-400'}`
                                }, date.getDate()),
                                h('div', { className: 'space-y-1' },
                                    dayEvents.map((event) => {
                                        const workType = workTypes.find(type => type.id === event.type);
                                        const Icon = workType.icon;
                                        return h('div', {
                                            key: event.id,
                                            className: `text-xs p-1.5 rounded-md text-white ${workType.color} flex items-center gap-1 group relative`,
                                            onClick: (e) => e.stopPropagation()
                                        },
                                            h(Icon, { className: 'icon-sm flex-shrink-0' }),
                                            h('span', { className: 'truncate flex-1' },
                                                `${event.startTime}-${event.endTime}`
                                            ),
                                            h('button', {
                                                onClick: () => removeEvent(date, event.id),
                                                className: 'opacity-0 group-hover:opacity-100 transition-opacity ml-1'
                                            }, h(Icons.X, { className: 'icon-sm' }))
                                        );
                                    })
                                )
                            );
                        })
                    )
                ),

                // Monthly Statistics
                monthlyStats.length > 0 && h('div', { className: 'bg-white rounded-2xl shadow-sm border border-gray-100 p-6' },
                    h('div', { className: 'flex items-center gap-3 mb-6' },
                        h(Icons.BarChart3, { className: 'icon-lg text-blue-600' }),
                        h('h3', { className: 'text-lg font-semibold text-gray-800' },
                            `${months[currentDate.getMonth()]} 工作時間統計`
                        )
                    ),
                    h('div', { className: 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4' },
                        monthlyStats.map((stat) =>
                            h('div', { key: stat.name, className: 'bg-gray-50 rounded-lg p-4' },
                                h('div', { className: 'flex items-center gap-3 mb-2' },
                                    h('div', { className: `w-4 h-4 rounded ${stat.color}` }),
                                    h('span', { className: 'font-medium text-gray-700' }, stat.name)
                                ),
                                h('div', { className: 'text-2xl font-bold text-gray-800 mb-1' },
                                    `${stat.hours.toFixed(1)} 小時`
                                ),
                                h('div', { className: 'text-sm text-gray-500' },
                                    `佔比 ${stat.percentage}%`
                                )
                            )
                        )
                    )
                ),

                // Modal
                showModal && h('div', { className: 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4' },
                    h('div', { className: 'bg-white rounded-2xl shadow-xl max-w-md w-full p-6' },
                        h('div', { className: 'flex items-center justify-between mb-4' },
                            h('h3', { className: 'text-lg font-semibold text-gray-800' }, '新增工作事項'),
                            h('button', {
                                onClick: () => setShowModal(false),
                                className: 'p-1 hover:bg-gray-100 rounded-lg'
                            }, h(Icons.X, { className: 'icon-lg' }))
                        ),
                        h('div', { className: 'text-sm text-gray-600 mb-4' },
                            `日期：${selectedDate?.getFullYear()}年${selectedDate?.getMonth() + 1}月${selectedDate?.getDate()}日`
                        ),
                        h('div', { className: 'space-y-4' },
                            h('div', { className: 'grid grid-cols-2 gap-4' },
                                h('div', {},
                                    h('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, '開始時間'),
                                    h('input', {
                                        type: 'time',
                                        value: eventForm.startTime,
                                        onChange: (e) => setEventForm(prev => ({ ...prev, startTime: e.target.value })),
                                        className: 'w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent'
                                    })
                                ),
                                h('div', {},
                                    h('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, '結束時間'),
                                    h('input', {
                                        type: 'time',
                                        value: eventForm.endTime,
                                        onChange: (e) => setEventForm(prev => ({ ...prev, endTime: e.target.value })),
                                        className: 'w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent'
                                    })
                                )
                            ),
                            h('div', {},
                                h('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, '工作類型'),
                                h('select', {
                                    value: eventForm.type,
                                    onChange: (e) => setEventForm(prev => ({ ...prev, type: e.target.value })),
                                    className: 'w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent'
                                },
                                    workTypes.map((type) =>
                                        h('option', { key: type.id, value: type.id }, type.name)
                                    )
                                )
                            ),
                            h('div', {},
                                h('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, '工作內容'),
                                h('input', {
                                    type: 'text',
                                    value: eventForm.description,
                                    onChange: (e) => setEventForm(prev => ({ ...prev, description: e.target.value })),
                                    placeholder: '請輸入工作內容描述',
                                    className: 'w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent'
                                })
                            ),
                            h('div', { className: 'flex gap-3 pt-4' },
                                h('button', {
                                    onClick: () => setShowModal(false),
                                    className: 'flex-1 py-2 px-4 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors'
                                }, '取消'),
                                h('button', {
                                    onClick: handleSubmit,
                                    className: 'flex-1 py-2 px-4 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center justify-center gap-2'
                                },
                                    h(Icons.Plus, { className: 'icon' }),
                                    '新增'
                                )
                            )
                        )
                    )
                )
            );
        };

        // 渲染應用程式
        ReactDOM.render(h(WorkCalendar), document.getElementById('root'));
    </script>
</body>
</html>
